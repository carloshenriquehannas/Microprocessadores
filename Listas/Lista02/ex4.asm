; Carlos Henrique Hannas de Carvalho
; NUSP: 11965988

DIG1		EQU	30H
DIG2		EQU	31H
DIG3		EQU	32H
DIG4		EQU	33H

		ORG	0000H
		SJMP	PROG

PROG:
		MOV	R0, #30H


LOOP_LEITURA:
		CJNE	R0, #34H, TEST
TEST:
		JNC	VERIFY
		ACALL	LE_TECLADO
		CJNE	A, #0FFH, SAVE_NUMBER
		SJMP 	LOOP_LEITURA
SAVE_NUMBER:	MOV	@R0, A
		INC	R0
		SJMP	LOOP_LEITURA

VERIFY:		MOV	A, DIG1
		SWAP	A
		ORL	A, DIG2
TEST_AB:	CJNE	A, #0ABH, TEST_00_1
		MOV	A, DIG3
		SWAP	A
		ORL	A, DIG4
		CJNE	A, #0CDH, IS_INVALID
		MOV	A, #1
		ACALL	ESCREVE_7SEG
		SJMP	PROG

TEST_00_1:
		CJNE	A, #00H, IS_INVALID

		MOV	A, DIG3
		SWAP	A
		ORL	A, DIG4
		CJNE	A, #00H, IS_INVALID
		MOV	A, #0
		ACALL	ESCREVE_7SEG

		SJMP	PROG

IS_INVALID:
		MOV	A, #8
		ACALL	ESCREVE_7SEG
		ACALL	DELAY

		ACALL	APAGA_7SEG
		ACALL	DELAY

		SJMP	IS_INVALID


LE_TECLADO:
		MOV	A, #0EFH
		MOV	R1, A

COL_1:
		ACALL	ESCREVE_TECLADO
		MOV	DPTR, #6000H
		MOVX	A, @DPTR
		JNB	A.0, TECLA_1
		JNB	A.1, TECLA_5
		JNB	A.2, TECLA_9
		JNB	A.3, TECLA_D

COL_2:
		MOV	A, R1
		RL	A
		MOV	R1, A
		ACALL	ESCREVE_TECLADO
		MOV	DPTR, #6000H
		MOVX	A, @DPTR
		JNB	A.0, TECLA_2
		JNB	A.1, TECLA_6
		JNB	A.2, TECLA_A
		JNB	A.3, TECLA_E

COL_3:
		MOV	A, R1
		RL	A
		MOV	R1, A
		ACALL	ESCREVE_TECLADO
		MOV	DPTR, #6000H
		MOVX	A, @DPTR
		JNB	A.0, TECLA_3
		JNB	A.1, TECLA_7
		JNB	A.2, TECLA_B
		JNB	A.3, TECLA_F

COL_4:
		MOV	A, R1
		RL	A
		ACALL	ESCREVE_TECLADO
		MOV	DPTR, #6000H
		MOVX	A, @DPTR
		JNB	A.0, TECLA_4
		JNB	A.1, TECLA_8
		JNB	A.2, TECLA_C
		JNB	A.3, TECLA_0

		MOV	A, #0FFH
		RET

ESCREVE_TECLADO:
		MOV	DPTR, #4000H
		MOVX	@DPTR, A
		RET


TECLA_1:
		MOV	A, #01H
		RET
TECLA_5:
		MOV	A, #05H
		RET
TECLA_9:
		MOV	A, #09H
		RET
TECLA_D:
		MOV	A, #0DH
		RET
TECLA_2:
		MOV	A, #02H
		RET
TECLA_6:
		MOV	A, #06H
		RET
TECLA_A:
		MOV	A, #0AH
		RET
TECLA_E:
		MOV	A, #0EH
		RET
TECLA_3:
		MOV	A, #03H
		RET
TECLA_7:
		MOV	A, #07H
		RET
TECLA_B:
		MOV	A, #0BH
		RET
TECLA_F:
		MOV	A, #0FH
		RET
TECLA_4:
		MOV	A, #04H
		RET
TECLA_8:
		MOV	A, #08H
		RET
TECLA_C:
		MOV	A, #0CH
		RET
TECLA_0:
		MOV	A, #00H
		RET

ESCREVE_7SEG:
		MOV	R7, A
		MOV	DPTR, #TAB
		MOVC	A, @A+DPTR

		MOV	DPTR, #8000H
		MOVX	@DPTR, A
		RET

APAGA_7SEG:
		MOV	A, #0
		MOV	DPTR, #8000H
		MOVX	@DPTR, A
		RET

DELAY:
		MOV	R3, #002h
		MOV	R2, #0ADh
		MOV	R1, #007h
		MOV	R0, #0BCh
		NOP
		DJNZ	R0, $
		DJNZ	R1, $-5
		DJNZ	R2, $-9
		DJNZ	R3, $-13
		MOV	R0, #061h
		DJNZ	R0, $
		NOP
		RET


TAB:		DB 	3FH, 06H, 5BH, 4FH, 66H, 6DH, 7DH, 07H, 7FH, 67H

		END
