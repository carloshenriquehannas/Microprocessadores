; Carlos Henrique Hannas de Carvalho
; NUSP: 11965988

INVALID		EQU	20H.0 
NEXT_CHAR_AD	EQU	21H 
END_CHAR_AD	EQU	22H 
RECEIVED	EQU	20H.1 
SEL_CHANNEL	EQU	24H 
DIG_SIGNAL_1	EQU	25H
DIG_SIGNAL_0	EQU	26H
BUSY		EQU	20H.2

		ORG	0000H
		SJMP	PROG

		ORG	0003
		SJMP	EOC

		ORG	0023H
		SJMP	SERIAL

PROG:
		SETB	EX0
		SETB	IT0

		SETB	ES	

		SETB	EA
		MOV	TMOD, #20H
		MOV	TH1, #253
		MOV	TL1, #253
		SETB	TR1
		MOV	SCON, #40H
		MOV	PCON, #080H

		SETB	REN

WAIT:
		JNB	RECEIVED, $

		MOV	A, SEL_CHANNEL
		CJNE	A, #1, TEST_NUM_1
TEST_NUM_1:
		JC	RESTART

		CJNE	A, #9, TEST_NUM_9
TEST_NUM_9:
		JNC	RESTART 
		CLR	EA

		MOV	DPTR, #0C000H
		MOV	A, SEL_CHANNEL
		CLR	C
		SUBB	A, #1
		MOV	DPL, A
		SETB	BUSY
		SETB	EA

RESTART:
		CLR	RECEIVED
		SJMP	WAIT

EOC:
		CLR	EA
		MOV	DPTR, #0A000H
		MOVX	A, @DPTR
		MOV	R0, A

		SWAP	A
		ANL	A, #0FH
		ACALL	CONV_HEX2ASCII
		MOV	DIG_SIGNAL_1, A

		MOV	A, R0
		ANL	A, #0FH
		ACALL	CONV_HEX2ASCII
		MOV	DIG_SIGNAL_0, A

		ACALL	SEND

		SETB	EA
		RETI

SERIAL:
		CLR	EA
		JB	TI, SENDED

RECEIVED:
		CLR	RI
		JB	BUSY, END_SERIAL

		MOV	A, SBUF
		ACALL	CONV_ASCII2HEX
		MOV	SEL_CHANNEL, A

		SETB	RECEIVED

		SJMP	END_SERIAL

SENDED:
		MOV	A, NEXT_CHAR_AD
		CJNE	A, END_CHAR_AD, TEST_END_CHAR
TEST_END_CHAR:
		JNC	END_SEND_BUFFER
		CLR	TI
		MOV	R0, NEXT_CHAR_AD
		MOV	SBUF, @R0
		INC	NEXT_CHAR_AD


END_SEND_BUFFER:
		CLR	BUSY

END_SERIAL:
		SETB	EA
		RETI

SEND:
		MOV	DPTR, #TAB_CANAL
		MOV	R0, #30H
LOOP_CANAL:
		MOV	A, #0
		MOVC	A, @A+DPTR
		CJNE	A, #00H, PUT_1
		SJMP	PUT_CANAL_N
PUT_1:
		MOV	@R0, A
		INC	DPTR
		INC	R0
		SJMP	LOOP_CANAL

PUT_CANAL_N:
		MOV	A, SEL_CHANNEL
		ACALL	CONV_HEX2ASCII
		MOV	@R0, A
		INC	R0
		MOV	DPTR, #TAB_IGUAL
LOOP_IGUAL:
		MOV	A, #0
		MOVC	A, @A+DPTR
		CJNE	A, #00H, PUT_2
		SJMP	PUT_SIGNAL
PUT_2:
		MOV	@R0, A
		INC	R0
		INC	DPTR
		SJMP	LOOP_IGUAL

PUT_SIGNAL:
		MOV	A, DIG_SIGNAL_1
		MOV	@R0, A
		INC	R0

		MOV	A, DIG_SIGNAL_0
		MOV	@R0, A
		INC	R0

START_SEND:
		MOV	NEXT_CHAR_AD, #30H
		MOV	END_CHAR_AD, R0

		CLR	TI
		MOV	R0, NEXT_CHAR_AD
		MOV	SBUF, @R0
		INC	NEXT_CHAR_AD

		RET

CONV_ASCII2HEX:
		CJNE	A, #30H, TEST_1
TEST_1:
		JC	SET_INV
		CJNE	A, #3AH, TEST_2
TEST_2:
		JC	NUM
		CJNE	A, #41H, TEST_3
TEST_3:
		JC	SET_INV
		CJNE	A, #47H, TEST_4
TEST_4:
		JNC	SET_INV
LETTER:
		CLR	C
		SUBB	A, #7H
NUM:
		CLR	C
		SUBB	A, #30H
		CLR	INVALID
		RET
SET_INV:
		SETB	INVALID
		RET

CONV_HEX2ASCII:
		CJNE	A, #0AH, TEST_A
TEST_A:
		JC	NUMBER
		ADD	A, #07H
NUMBER:
		ADD	A, #30H
		RET


TAB_CANAL:
		DB	'CANAL ',00H
		DB	00H
TAB_IGUAL:
		DB	' = '
		DB	00H

		END
